{
    "Title": "Codeforces Round 1048 (Div. 1)",
    "Source": "codeforces",
    "Name": "Maple and Tree Beauty (Hard Version)",
    "Time Limit": "6 s",
    "Memory Limit": "1024 mb",
    "Problem Statement": "This is the hard version of the problem. The difference between the versions is that in this version, the constraints on $t$ and $n$ are larger. You can hack only if you solved all versions of this problem. \nMaple is given a rooted tree consisting of $n$ vertices numbered from $1$ to $n$, where the root has index $1$. Each vertex of the tree is labeled either zero or one. Unfortunately, Maple forgot how the vertices are labeled and only remembers that there are exactly $k$ zeros and $n - k$ ones.\nFor each vertex, we define the name of the vertex as the binary string formed by concatenating the labels of the vertices from the root to the vertex. More formally, $\\text{name}_1 = \\text{label}_1$ and $\\text{name}_u = \\text{name}_{p_u} + \\text{label}_u$ for all $2≤ u≤ n$, where $p_u$ is the parent of vertex $u$ and $+$ represents string concatenation.\nThe beauty of the tree is equal to the length of the longest common subsequence$^{\\text{∗}}$ of the names of all the leaves$^{\\text{†}}$. Your task is to determine the maximum beauty among all labelings of the tree with exactly $k$ zeros and $n - k$ ones.\n$^{\\text{∗}}$A sequence $a$ is a subsequence of a sequence $b$ if $a$ can be obtained from $b$ by the deletion of several (possibly, zero or all) element from arbitrary positions. The longest common subsequence of strings $s_1, s_2, ... s_m$ is the longest string that is a subsequence of all of $s_1, s_2, ..., s_m$.\n$^{\\text{†}}$A leaf is any vertex without children.",
    "Statement Images": [],
    "Constraints": "Time limit: 6 s\nMemory limit: 1024 mb",
    "IO Styles": "Input\nEach test contains multiple test cases. The first line contains the number of test cases $t$ ($1 ≤ t ≤ 10^4$). The description of the test cases follows. \nThe first line of each test case contains two integers $n$ and $k$ ($2 ≤ n ≤ 2\\cdot 10 ^ 5$, $0 ≤ k ≤ n$) — the number of vertices and the number of vertices labelled with zero, respectively.\nThe second line contains $n - 1$ integers $p_2, p_3, ..., p_{n}$ ($1 ≤ p_i ≤ i - 1$) — the parent of vertex $i$.\nIt is guaranteed that the sum of $n$ over all test cases does not exceed $2 \\cdot 10^5$. \nOutput\nFor each test case, output a single integer representing the maximum beauty among all labelings of the tree with exactly $k$ zeroes and $n - k$ ones.",
    "Sample Detail": [
        {
            "input": "5\n7 3\n1 1 2 2 3 3\n7 2\n1 1 2 3 1 1\n5 0\n1 2 3 4\n5 2\n1 1 1 1\n5 4\n1 1 1 1",
            "output": "3\n2\n5\n1\n2",
            "explanation": "",
            "images": []
        }
    ],
    "Notes": "Note ![image](1.png)  In the first test case, the maximum beauty is $3$, when the vertices are labeled with $[0, 0, 0, 1, 1, 1, 1]$, and the longest common subsequence is 001. ![image](2.png)  In the second test case, the maximum beauty is $2$, when the vertices are labeled with $[1, 0, 0, 1, 1, 1, 1]$, and the longest common subsequence is 11.",
    "Note Images": [
        "https://espresso.codeforces.com/1f47a18ed60774e1e086fda1e69e6a508ece64a4.png",
        "https://espresso.codeforces.com/f2f618bf41cbf9ec7e446bf2fd42534266263584.png"
    ],
    "Language": "en"
}